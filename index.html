<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pocket Focus</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- MOBILE WEB APP, ADD THIS TO <head>..</head> OF index.html -->
       <link rel="icon" type="image/png" href="favicon.png" />
       <link rel="apple-touch-icon" href="favicon.png">
       <meta name="apple-mobile-web-app-title" content="">
       <meta name="apple-mobile-web-app-capable" content="yes">
       <meta name="apple-mobile-web-app-status-bar-style" content="black">


    <style>
        /* Configure Tailwind to use a dark theme by default */
        :root {
            color-scheme: dark;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); /* Deep background gradient */
            color: #f8fafc;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* Glassmorphism Effect for Cards */
        .glass-card {
            background: rgba(30, 41, 59, 0.6); /* Slightly transparent dark slate */
            border-radius: 20px;
            border: 1px solid rgba(100, 116, 139, 0.3); /* Subtle border */
            backdrop-filter: blur(15px); /* The glass effect */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), 0 0 50px rgba(99, 102, 241, 0.1); /* Deep outer shadow & neon glow */
            padding: 2rem;
            transition: transform 0.3s ease;
        }
        
        .glass-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6), 0 0 70px rgba(99, 102, 241, 0.2);
        }

        /* Styling for the large timer digits - Neon Glow */
        #timer-display {
            color: #6366f1; /* Indigo 500 */
            font-size: clamp(3rem, 10vw, 7rem);
            font-weight: 800;
            line-height: 1;
            letter-spacing: -3px;
            text-shadow: 
                0 0 10px rgba(99, 102, 241, 0.6), 
                0 0 20px rgba(99, 102, 241, 0.4);
            animation: pulse 1.5s infinite alternate;
        }

        @keyframes pulse {
            from { opacity: 0.9; }
            to { opacity: 1; }
        }

        .action-button {
            padding: 1rem 1.5rem;
            border-radius: 12px;
            font-weight: 700;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            text-transform: uppercase;
        }

        .action-button:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.5);
        }
        
        .action-button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
            filter: grayscale(10%);
        }

        .bg-log { background-color: #3b82f6; } /* Blue for LOG */
        .hover\:bg-log:hover:not(:disabled) { background-color: #2563eb; }
        .shadow-log { box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }

        .bg-lap { background-color: #475569; } /* Slate for LAP/RESET */
        .hover\:bg-lap:hover:not(:disabled) { background-color: #334155; }
        .shadow-lap { box-shadow: 0 0 10px rgba(71, 85, 105, 0.3); }

        .bg-start { background-color: #10b981; } /* Emerald for START */
        .hover\:bg-start:hover:not(:disabled) { background-color: #059669; }
        .shadow-start { box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }

        .bg-stop { background-color: #ef4444; } /* Red for STOP */
        .hover\:bg-stop:hover:not(:disabled) { background-color: #dc2626; }
        .shadow-stop { box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); }

        /* Custom Input styling */
        #activity-input {
            border: 1px solid rgba(100, 116, 139, 0.3);
            background: rgba(30, 41, 59, 0.4);
        }
        #activity-input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5);
        }
        
        /* Modal styling */
        .modal-content {
            background: #1e293b;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.7);
        }

    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Main Container -->
    <div class="w-full max-w-2xl flex flex-col items-center">

        <!-- Header Section -->
        <header class="text-center mb-10 w-full">
            <h1 class="text-4xl sm:text-5xl font-black text-indigo-400 pb-1 tracking-tighter">
                Pocket Focus
            </h1>
            <p class="text-md text-gray-400 mt-1">
                Precision Timing & Data Visualization
            </p>
        </header>

        <!-- Timer and Input Card -->
        <main class="w-full glass-card mb-8">
            
            <!-- Activity Input Section -->
            <div class="mb-8">
                <label for="activity-input" class="block text-sm font-semibold text-indigo-300 mb-2 tracking-wider">ACTIVITY</label>
                <div class="flex items-center">
                    <i data-lucide="activity" class="w-5 h-5 text-indigo-400 mr-3 opacity-80"></i>
                    <input
                        id="activity-input"
                        type="text"
                        placeholder="e.g., Quantum Physics Research"
                        class="w-full rounded-lg p-3 text-gray-50 text-lg transition-all focus:outline-none"
                        value="Deep Work Session"
                    />
                </div>
            </div>

            <!-- Timer Display -->
            <div class="flex justify-center mb-10">
                <div id="timer-display">00:00.00</div>
            </div>

            <!-- Control Buttons Grid -->
            <div class="grid grid-cols-3 gap-4">
                
                <!-- RESET/LAP Button -->
                <button id="reset-button" class="action-button bg-lap hover:bg-lap shadow-lap text-white" onclick="resetOrLapTimer()">
                    <i data-lucide="repeat" class="w-5 h-5 mr-1"></i>
                    <span id="reset-text">RESET</span>
                </button>

                <!-- LOG Button -->
                <button id="log-button" disabled class="action-button bg-log hover:bg-log shadow-log text-white" onclick="logData()">
                    <i data-lucide="save" class="w-5 h-5 mr-1"></i>
                    LOG
                </button>
                
                <!-- START/STOP Button -->
                <button id="start-stop-button" class="action-button bg-start hover:bg-start shadow-start text-white" onclick="toggleTimer()">
                    <i data-lucide="play" class="w-5 h-5 mr-1" id="start-stop-icon"></i>
                    <span id="start-stop-text">START</span>
                </button>
            </div>
        </main>

        <!-- Chart Dashboard Card -->
        <section class="w-full glass-card mb-8">
            <h2 class="text-xl font-bold mb-4 text-indigo-300 flex items-center">
                <i data-lucide="bar-chart-3" class="w-5 h-5 mr-2 text-indigo-400"></i>
                Accumulated Focus Time (Hours)
            </h2>
            <p id="chart-status" class="text-gray-400 text-sm mb-4">Loading data...</p>
            <div class="h-64">
                <canvas id="focusChart"></canvas>
            </div>
        </section>

        <!-- Footer for Last Log & User ID -->
        <footer class="text-center text-sm text-gray-400 opacity-80 pt-4 w-full">
            <p id="last-log-display" class="mb-2">No logs yet. Start your first session!</p>
            <p class="text-xs">
                User ID: <span id="user-id-display" class="font-mono text-gray-300">Authenticating...</span>
            </p>
        </footer>
    </div>

    <!-- Custom Modal for Messages (replaces alert()) -->
    <div id="app-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-indigo-400"></h3>
            <p id="modal-message" class="mb-4 text-gray-200"></p>
            <button class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors" onclick="closeModal()">
                OK
            </button>
        </div>
    </div>

    <!-- JavaScript and Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables ---
        let db;
        let auth;
        let userId = null;
        let focusChartInstance = null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- DOM Elements ---
        const timerDisplay = document.getElementById('timer-display');
        const startStopButton = document.getElementById('start-stop-button');
        const startStopIcon = document.getElementById('start-stop-icon');
        const startStopText = document.getElementById('start-stop-text');
        const logButton = document.getElementById('log-button');
        const resetButton = document.getElementById('reset-button');
        const resetText = document.getElementById('reset-text');
        const activityInput = document.getElementById('activity-input');
        const lastLogDisplay = document.getElementById('last-log-display');
        const chartStatus = document.getElementById('chart-status');
        const userIdDisplay = document.getElementById('user-id-display');

        // --- Timer State ---
        let timerInterval = null;
        let startTime = 0;
        let elapsedTime = 0;
        let isRunning = false;

        // --- Utility Functions ---

        /** Converts milliseconds to a human-readable MM:SS.cc format. */
        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const centiseconds = Math.floor((ms % 1000) / 10);

            const pad = (num) => num.toString().padStart(2, '0');
            return `${pad(minutes)}:${pad(seconds)}.${pad(centiseconds)}`;
        }

        /** Displays the custom modal message. */
        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('app-modal').style.display = 'flex';
        }

        window.closeModal = function() {
            document.getElementById('app-modal').style.display = 'none';
        }
        
        // --- Timer UI State Management ---

        function updateTimerControls() {
            // Reset Button changes label based on state
            resetText.textContent = isRunning ? 'LAP' : 'RESET';

            // Start/Stop Button state
            startStopButton.classList.remove('bg-start', 'hover:bg-start', 'shadow-start', 'bg-stop', 'hover:bg-stop', 'shadow-stop');

            if (isRunning) {
                startStopButton.classList.add('bg-stop', 'hover:bg-stop', 'shadow-stop');
                startStopIcon.setAttribute('data-lucide', 'square');
                startStopText.textContent = 'STOP';
                logButton.disabled = true;
            } else {
                startStopButton.classList.add('bg-start', 'hover:bg-start', 'shadow-start');
                startStopIcon.setAttribute('data-lucide', 'play');
                startStopText.textContent = 'START';
                logButton.disabled = (elapsedTime < 1000); // Only allow logging after 1 second
            }
            
            // Re-render icons after changing attributes
            lucide.createIcons();
        }

        // --- Timer Logic ---
        
        /**
         * Updates the timer display every 10ms.
         */
        function updateDisplay() {
            const now = Date.now();
            elapsedTime = now - startTime;
            timerDisplay.textContent = formatTime(elapsedTime);
        }

        window.toggleTimer = function() {
            if (isRunning) {
                // Stop timer
                isRunning = false;
                clearInterval(timerInterval);
                timerInterval = null;
            } else {
                // Start timer
                if (elapsedTime > 0 && startTime !== 0) {
                    startTime = Date.now() - elapsedTime; // Resume
                } else {
                    startTime = Date.now(); // New start
                }
                isRunning = true;
                timerInterval = setInterval(updateDisplay, 10);
            }
            updateTimerControls();
        }
        
        window.resetOrLapTimer = function() {
            if (isRunning) {
                // LAP functionality (logs the current split time)
                const activity = activityInput.value.trim() || 'Unspecified Lap';
                const durationMs = elapsedTime;
                logEntry(activity, durationMs, true); // Log as a Lap
            } else {
                // RESET functionality
                elapsedTime = 0;
                startTime = 0;
                timerDisplay.textContent = '00:00.00';
                updateTimerControls();
            }
        }
        
        // --- Logging and Firebase Logic ---

        async function logEntry(activity, durationMs, isLap = false) {
            if (!userId) {
                showModal('Logging Error', 'App is still authenticating. Please wait a moment.');
                return;
            }
            
            const logEntry = {
                userId: userId,
                activity: activity,
                durationMs: durationMs,
                timestamp: Date.now(),
                isLap: isLap
            };

            try {
                const logCollection = collection(db, `artifacts/${appId}/users/${userId}/focus_logs`);
                await addDoc(logCollection, logEntry);

                const formattedDuration = formatTime(durationMs);

                showModal(
                    isLap ? 'Lap Logged!' : 'Session Logged!',
                    `${isLap ? 'Lap' : 'Session'} "${activity}" recorded: ${formattedDuration}.`
                );

                // For full session log, reset timer, but for lap, keep running
                if (!isLap) {
                    elapsedTime = 0;
                    startTime = 0;
                    timerDisplay.textContent = '00:00.00';
                    updateTimerControls(); // Re-check logging capability
                }
                
                // Update dashboard
                await fetchAndRenderDashboard();

            } catch (e) {
                console.error("Error adding document: ", e);
                showModal('Logging Failed', 'Could not save data to the database. Check console for details.');
            }
        }

        window.logData = function() {
            if (isRunning || elapsedTime < 1000 || !userId) { 
                showModal('Logging Error', 'Timer must be stopped and run for at least 1 second to log data.');
                return;
            }

            const activity = activityInput.value.trim() || 'Unspecified Focus Session';
            logEntry(activity, elapsedTime, false);
        }
        
        // --- Dashboard Logic ---
        
        async function fetchAndRenderDashboard() {
            if (!db || !userId) {
                chartStatus.textContent = "Authentication required to load dashboard.";
                return;
            }

            chartStatus.textContent = "Fetching logs and building chart...";
            console.log("[Firestore] Fetching logs for user:", userId);

            try {
                const logCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/focus_logs`);
                const querySnapshot = await getDocs(logCollectionRef);

                console.log(`[Firestore] Found ${querySnapshot.size} documents.`);

                let totalDurationByActivity = {};
                let latestLog = null;
                let logCount = 0;

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const activity = data.activity || 'Unspecified Activity';
                    const duration = data.durationMs || 0;
                    logCount++;

                    // Aggregate total duration
                    totalDurationByActivity[activity] = (totalDurationByActivity[activity] || 0) + duration;

                    // Track latest log
                    if (!latestLog || data.timestamp > latestLog.timestamp) {
                        latestLog = data;
                    }
                });

                renderChart(totalDurationByActivity, logCount);
                updateLastLogDisplay(latestLog);

            } catch (error) {
                console.error("[Firestore ERROR] Error fetching logs for dashboard: ", error);
                chartStatus.textContent = "Error loading dashboard data.";
            }
        }

        function renderChart(data, logCount) {
            const labels = Object.keys(data);
            // Convert milliseconds to hours for display on the chart
            const chartData = labels.map(label => (data[label] / (1000 * 60 * 60)).toFixed(2));

            if (focusChartInstance) {
                focusChartInstance.destroy();
            }

            const canvasElement = document.getElementById('focusChart');
            if (!canvasElement) {
                console.error("[Chart ERROR] Canvas element 'focusChart' not found.");
                return;
            }
            const ctx = canvasElement.getContext('2d');
            
            if (labels.length === 0) {
                chartStatus.textContent = `No focus sessions logged yet. Total logs: ${logCount}.`;
                return;
            }
            chartStatus.textContent = `Total Time Logged Per Activity (in Hours). Total logs: ${logCount}.`;

            // Dynamic colors for the bars to look better with the dark theme
            const chartBarColor = labels.map((_, index) => {
                const colors = ['#6366f1', '#3b82f6', '#10b981', '#f97316']; // Indigo, Blue, Emerald, Orange
                return colors[index % colors.length];
            });


            focusChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Time Logged (Hours)',
                        data: chartData,
                        backgroundColor: chartBarColor, 
                        borderColor: '#1e293b',
                        borderWidth: 1,
                        borderRadius: 8, // Rounded bars look modern
                        hoverBackgroundColor: chartBarColor.map(c => `${c}B0`), // Slightly transparent on hover
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Hours', color: '#94a3b8' },
                            ticks: { color: '#e2e8f0' },
                            grid: { color: 'rgba(100, 116, 139, 0.3)' } /* Lighter grid lines for dark mode */
                        },
                        x: {
                            ticks: { color: '#e2e8f0' },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#0f172a',
                            titleColor: '#6366f1',
                            bodyColor: '#e2e8f0',
                            borderColor: '#6366f1',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    label += context.parsed.y + ' hours';
                                    return label;
                                }
                            }
                        }
                    },
                    color: '#e2e8f0',
                }
            });
        }

        function updateLastLogDisplay(lastLog) {
            if (lastLog) {
                const formattedTime = formatTime(lastLog.durationMs);
                const date = new Date(lastLog.timestamp).toLocaleDateString(undefined, {
                    hour: '2-digit', minute: '2-digit'
                });

                lastLogDisplay.innerHTML = `Last Logged: <b>${lastLog.activity}</b> for <b>${formattedTime}</b> on ${date}`;
            } else {
                lastLogDisplay.textContent = 'No logs yet. Start your first session!';
            }
        }


        // --- Initialization ---

        const initFirebase = async () => {
            if (!Object.keys(firebaseConfig).length) {
                console.error("Firebase config is missing. Data logging will not work.");
                return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate the user
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        // Fetch the dashboard immediately after successful auth
                        await fetchAndRenderDashboard();
                    } else {
                        // Attempt to sign in if not already authenticated
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                showModal('Initialization Failed', 'Database connection failed. Check console for details.');
            }
        };

        // Initialize on load
        window.onload = function() {
            // Render Lucide icons
            lucide.createIcons();
            
            // Set initial control states
            updateTimerControls();

            initFirebase();
        }

    </script>
</body>
</html>